{"version":3,"sources":["../src/server.js"],"names":["require","config","SocketServer","Server","RP","spotify","urls","router","express","Router","allowCrossDomain","req","res","next","header","method","send","use","setHeader","wss","master","track_uri","track_name","artist_name","play_position","selector_name","selector_token","album_cover","host","token","name","users","rooms","system_message_buffer","JSON","stringify","type","user_object","master_object","message","message_buffer","getCurrentUser","allUsers","user_to_return","forEach","user","get","state","cookie","STATE_KEY","redirect","querystring","spotifyOptions","HOST_REDIRECT_URI","MODE","console","log","GUEST_REDIRECT_URI","ERROR","code","query","storedState","headers","split","queryStringError","clearCookie","post","authOptions","error","response","body","statusCode","access_token","getUserOptions","then","user_details","display_name","push","CONNECTION","room_index","length","pollUsersPlayback","catch","e","newUser","checkCurrentTrack","obj","setPlaybackOptions","PLAYBACK_DELAY","syncToMaster","allRoomUsers","some","result","getTrack","track","album","images","url","SELECTOR_CALLS","Math","floor","random","clients","each","client","splice","indexOf","resync","setInterval","room","roomIndex","Promise","resolve","reject","getPlaybackOptions","master_ref","item","uri","artists","progress_ms","app","listen","SERVER_PORT","server","path","array","Float32Array","i","on","connection","ws"],"mappings":";;AAIA;;;;AACA;;;;AAQA;;AACA;;;;;;AAdA;AACA;AACA;AACAA,QAAQ,QAAR,EAAkBC,MAAlB;;AAGA,IAAMC,eAAeF,QAAQ,IAAR,EAAcG,MAAnC;AACA,IAAMC,KAAKJ,QAAQ,iBAAR,CAAX;AACA,IAAMK,UAAUL,QAAQ,sBAAR,CAAhB;AACA,IAAMC,SAASD,QAAQ,gBAAR,CAAf;AACA,IAAMM,OAAON,QAAQ,cAAR,CAAb;;AAEA;;;AAIA,IAAMO,SAASC,kBAAQC,MAAR,EAAf;;AAEA;AACA,IAAIC,mBAAmB,SAAnBA,gBAAmB,CAAUC,GAAV,EAAeC,GAAf,EAAoBC,IAApB,EAA0B;AAC/CD,MAAIE,MAAJ,CAAW,6BAAX,EAA0C,GAA1C;AACAF,MAAIE,MAAJ,CAAW,8BAAX,EAA2C,6BAA3C;AACAF,MAAIE,MAAJ,CAAW,8BAAX,EAA2C,+DAA3C;AACA,MAAI,aAAaH,IAAII,MAArB,EAA6B;AAC3BH,QAAII,IAAJ,CAAS,GAAT;AACD,GAFD,MAGK;AACHH;AACD;AACF,CAVD;;AAYA,yBAAUI,GAAV,CAAcP,gBAAd;AACA,yBAAUO,GAAV,CAAc,UAAUN,GAAV,EAAeC,GAAf,EAAoBC,IAApB,EAA0B;AACtCD,MAAIM,SAAJ,CAAc,6BAAd,EAA6C,GAA7C;AACAN,MAAIM,SAAJ,CAAc,8BAAd,EAA8C,wCAA9C;AACAN,MAAIM,SAAJ,CAAc,8BAAd,EAA8C,+BAA9C;AACAN,MAAIM,SAAJ,CAAc,kCAAd,EAAkD,IAAlD;AACAL;AACD,CAND;;AAQA;AACA,IAAIM,YAAJ;AACA,IAAIC,SAAS;AACXC,aAAW,IADA;AAEXC,cAAY,IAFD;AAGXC,eAAa,IAHF;AAIXC,iBAAe,IAJJ;AAKXC,iBAAe,IALJ;AAMXC,kBAAgB,IANL;AAOXC,eAAa;AAPF,CAAb;AASA,IAAMC,OAAO,EAAEC,OAAO,IAAT,EAAeC,MAAM,IAArB,EAAb;AACA,IAAIC,QAAQ,EAAZ;AACA,IAAIC,QAAQ,EAAZ;AACA,IAAIC,wBAAwBC,KAAKC,SAAL,CAAe;AACzCC,QAAM,EADmC;AAEzCC,eAAa,EAF4B;AAGzCC,iBAAe,EAH0B;AAIzCC,WAAS;AAJgC,CAAf,CAA5B;AAMA,IAAIC,iBAAiBN,KAAKC,SAAL,CAAe;AAClCC,QAAM,EAD4B;AAElCC,eAAa,EAFqB;AAGlCC,iBAAe,EAHmB;AAIlCC,WAAS;AAJyB,CAAf,CAArB;;AAQA;AACA,IAAME,iBAAiB,SAAjBA,cAAiB,CAACZ,KAAD,EAAW;AAChC,MAAIa,qBAAeX,KAAf,GAAsBH,IAAtB,EAAJ;AACA,MAAIe,uBAAJ;AACAD,WAASE,OAAT,CAAiB,gBAAQ;AACvB,QAAIC,KAAKhB,KAAL,KAAeA,KAAnB,EAA0B;AACxBc,uBAAiBE,IAAjB;AACD;AACF,GAJD;AAKA,SAAOF,cAAP;AACD,CATD;;AAYA;AACA;AACApC,OAAOuC,GAAP,CAAW,QAAX,EAAqB,UAAUnC,GAAV,EAAeC,GAAf,EAAoB;AACvC,MAAMmC,QAAQ,iCAAqB,EAArB,CAAd;AACAnC,MAAIoC,MAAJ,CAAW/C,OAAOgD,SAAlB,EAA6BF,KAA7B;AACA,MAAI,CAACnB,KAAKC,KAAV,EAAiB;AACfjB,QAAIsC,QAAJ,6CAAuDC,sBAAYhB,SAAZ,CAAsB9B,QAAQ+C,cAAR,CAAuB9C,KAAK+C,iBAAL,CAAuBpD,OAAOqD,IAA9B,CAAvB,EAA4DP,KAA5D,CAAtB,CAAvD;AACD,GAFD,MAEO;AACLnC,QAAIsC,QAAJ,CAAa,uBAAW,eAAX,CAAb;AACAK,YAAQC,GAAR,CAAY,gBAAZ;AACD;AACF,CATD;AAUA;AACAjD,OAAOuC,GAAP,CAAW,SAAX,EAAsB,UAAUnC,GAAV,EAAeC,GAAf,EAAoB;AACxC,MAAMmC,QAAQ,iCAAqB,EAArB,CAAd;AACAnC,MAAIoC,MAAJ,CAAW/C,OAAOgD,SAAlB,EAA6BF,KAA7B;AACA,MAAInB,KAAKC,KAAT,EAAgB;AACdjB,QAAIsC,QAAJ,6CAAuDC,sBAAYhB,SAAZ,CAAsB9B,QAAQ+C,cAAR,CAAuB9C,KAAKmD,kBAAL,CAAwBxD,OAAOqD,IAA/B,CAAvB,EAA6DP,KAA7D,CAAtB,CAAvD;AACD,GAFD,MAEO;AACLnC,QAAIsC,QAAJ,CAAa,uBAAW,mBAAX,EAAgCQ,gBAAhC,CAAb;AACAH,YAAQC,GAAR,CAAY,mBAAZ;AACD;AACF,CATD;AAUA;AACAjD,OAAOuC,GAAP,CAAW,WAAX,EAAwB,UAAUnC,GAAV,EAAeC,GAAf,EAAoB;AAC1C,MAAM+C,OAAOhD,IAAIiD,KAAJ,CAAUD,IAAV,IAAkB,IAA/B;AACA,MAAMZ,QAAQpC,IAAIiD,KAAJ,CAAUb,KAAV,IAAmB,IAAjC;AACA,MAAMc,cAAclD,IAAImD,OAAJ,CAAYd,MAAZ,GAAqBrC,IAAImD,OAAJ,CAAYd,MAAZ,CAAmBe,KAAnB,CAA4B9D,OAAOgD,SAAnC,QAAiD,CAAjD,CAArB,GAA2E,IAA/F;AACA,MAAIF,UAAU,IAAV,IAAkBA,UAAUc,WAAhC,EAA6C;AAC3CjD,QAAIsC,QAAJ,CAAa,OAAOc,uBAApB;AACD,GAFD,MAEO;AACLpD,QAAIqD,WAAJ,CAAgBhE,OAAOgD,SAAvB;;AAEA7C,OAAG8D,IAAH,CAAQ7D,QAAQ8D,WAAR,CAAoB7D,KAAK+C,iBAAL,CAAuBpD,OAAOqD,IAA9B,CAApB,EAAyDK,IAAzD,CAAR,EAAwE,UAAUS,KAAV,EAAiBC,QAAjB,EAA2BC,IAA3B,EAAiC;AACvG,UAAI,CAACF,KAAD,IAAUC,SAASE,UAAT,KAAwB,GAAtC,EAA2C;AACzC3C,aAAKC,KAAL,GAAayC,KAAKE,YAAlB;AACA;;AAEApE,WAAGC,QAAQoE,cAAR,CAAuB7C,IAAvB,CAAH,EACG8C,IADH,CACQ,UAACC,YAAD,EAAkB;AACtB;AACA;AACA/C,eAAKE,IAAL,GAAY,6BAAiB6C,aAAaC,YAA9B,CAAZ;AACA5C,gBAAM6C,IAAN,CAAW,EAAEjD,MAAMA,IAAR,EAAcG,OAAM,EAApB,EAAX;AACAE,kCAAwB,uBAAc,6BAAiBL,KAAKE,IAAtB,CAAd,iCAAuEF,IAAvE,EAA6ER,MAA7E,EAAqF0D,qBAArF,CAAxB;AACAlE,cAAIsC,QAAJ,CAAa,uBAAW,kBAAkBC,sBAAYhB,SAAZ,CAAsB,EAAEN,OAAOD,KAAKC,KAAd,EAAqBkD,YAAY/C,MAAMgD,MAAvC,EAAtB,CAA7B,CAAb;AACAC;AACD,SATH,EAUGC,KAVH,CAUS,aAAK;AACVtE,cAAIsC,QAAJ,CAAa,uBAAW,sBAAX,EAAmCQ,gBAAnC,CAAb;AACAH,kBAAQC,GAAR,CAAY,uBAAZ,EAAqC2B,CAArC;AACD,SAbH;AAcD,OAlBD,MAkBO;AACLvE,YAAIsC,QAAJ,CAAa,uBAAW,mBAAX,EAAgCQ,gBAAhC,CAAb;AACAH,gBAAQC,GAAR,CAAY,oBAAZ,EAAkC2B,CAAlC;AACD;AACF,KAvBD;AAwBD;AACF,CAlCD;AAmCA;AACA5E,OAAOuC,GAAP,CAAW,gBAAX,EAA6B,UAAUnC,GAAV,EAAeC,GAAf,EAAoB;AAC/C,MAAM+C,OAAOhD,IAAIiD,KAAJ,CAAUD,IAAV,IAAkB,IAA/B;AACA,MAAMZ,QAAQpC,IAAIiD,KAAJ,CAAUb,KAAV,IAAmB,IAAjC;AACA,MAAMgC,aAAapE,IAAIiD,KAAJ,CAAUmB,UAAV,IAAwB,CAA3C;AACA,MAAMlB,cAAclD,IAAImD,OAAJ,CAAYd,MAAZ,GAAqBrC,IAAImD,OAAJ,CAAYd,MAAZ,CAAmBe,KAAnB,CAA4B9D,OAAOgD,SAAnC,QAAiD,CAAjD,CAArB,GAA2E,IAA/F;AACA,MAAIF,UAAU,IAAV,IAAkBA,UAAUc,WAAhC,EAA6C;AAC3CjD,QAAIsC,QAAJ,CAAa,OAAOc,uBAApB;AACD,GAFD,MAEO;AACLpD,QAAIqD,WAAJ,CAAgBhE,OAAOgD,SAAvB;;AAEA7C,OAAG8D,IAAH,CAAQ7D,QAAQ8D,WAAR,CAAoB7D,KAAKmD,kBAAL,CAAwBxD,OAAOqD,IAA/B,CAApB,EAA0DK,IAA1D,CAAR,EAAyE,UAAUS,KAAV,EAAiBC,QAAjB,EAA2BC,IAA3B,EAAiC;AACxG,UAAI,CAACF,KAAD,IAAUC,SAASE,UAAT,KAAwB,GAAtC,EAA2C;AACzC,YAAIa,UAAU,EAAd;AACAA,gBAAQvD,KAAR,GAAgByC,KAAKE,YAArB;AACApE,WAAGC,QAAQoE,cAAR,CAAuBW,OAAvB,CAAH,EACGV,IADH,CACQ,wBAAgB;AACpBnB,kBAAQC,GAAR,CAAemB,aAAa7C,IAA5B;AACAsD,kBAAQtD,IAAR,GAAe6C,aAAaC,YAA5B;;AAEA,iBAAOS,kBAAkBzD,IAAlB,EAAwBR,MAAxB,CAAP;AACD,SANH,EAOGsD,IAPH,CAOQ,eAAO;AACXtD,mBAASkE,GAAT;AACA;AACA,iBAAOlF,GAAGC,QAAQkF,kBAAR,CAA2BH,OAA3B,EAAoChE,MAApC,EAA4CnB,OAAOuF,cAAnD,CAAH,CAAP;AACD,SAXH,EAYGd,IAZH,CAYQ,YAAM;AACV;AACA1C,gBAAM+C,UAAN,EAAkBhD,KAAlB,CAAwB8C,IAAxB,CAA6BO,OAA7B;AACA;AACAnD,kCAAwB,uBAAc,6BAAiBmD,QAAQtD,IAAzB,CAAd,2BAAoEsD,OAApE,EAA6EhE,MAA7E,EAAqF0D,qBAArF,CAAxB;AACAlE,cAAIsC,QAAJ,CAAa,uBAAW,mBAAmBC,sBAAYhB,SAAZ,CAAsB,EAAEN,OAAOuD,QAAQvD,KAAjB,EAAtB,CAA9B,CAAb;AACD,SAlBH,EAmBGqD,KAnBH,CAmBS,aAAK;AACVtE,cAAIsC,QAAJ,CAAa,uBAAW,YAAX,EAAyBQ,gBAAzB,CAAb;AACAH,kBAAQC,GAAR,CAAY,sBAAZ,EAAoC2B,CAApC;AACD,SAtBH;AAuBD,OA1BD,MA0BO;AACLvE,YAAIsC,QAAJ,CAAa,uBAAW,gBAAX,EAA6BQ,gBAA7B,CAAb;AACAH,gBAAQC,GAAR,CAAY,0BAAZ,EAAwC2B,CAAxC;AACD;AACF,KA/BD;AAgCD;AACF,CA3CD;;AA8CA,IAAMM,eAAe,SAAfA,YAAe,CAAC7D,IAAD,EAAOG,KAAP,EAAiB;AACpC,MAAIH,KAAKC,KAAL,IAAcE,KAAlB,EAAyB;AACvB,QAAI2D,4CAAmB3D,KAAnB,IAA0BH,IAA1B,EAAJ;AACA2B,YAAQC,GAAR,CAAY,cAAZ;AACA;AACAkC,iBAAaC,IAAb,CACE,UAAC9C,IAAD,EAAU;AACR,+BAAa,GAAb,EACG6B,IADH,CACQ;AAAA,eAAMW,kBAAkBxC,IAAlB,CAAN;AAAA,OADR,EAEG6B,IAFH,CAEQ,kBAAU;AACd,YAAIkB,OAAOvE,SAAP,KAAqBD,OAAOC,SAAhC,EAA2C;AACzC;AACAD,mBAASwE,MAAT;AACA,iBAAOxF,GAAGC,QAAQwF,QAAR,CAAiBhD,IAAjB,EAAuBzB,OAAOC,SAAP,CAAiB0C,KAAjB,CAAuB,QAAvB,EAAiC,CAAjC,CAAvB,CAAH,EACJW,IADI,CACC,UAACoB,KAAD,EAAW;AACf1E,mBAAOO,WAAP,GAAqBmE,MAAMC,KAAN,CAAYC,MAAZ,CAAmB,CAAnB,EAAsBC,GAA3C;AACA;;AAEAhE,oCAAwB,uBACnB,6BAAiBb,OAAOK,aAAxB,CADmB,SACuByE,0BAAeC,KAAKC,KAAL,CAAWD,KAAKE,MAAL,KAAgBH,0BAAelB,MAA1C,CAAf,CADvB,SAC4F5D,OAAOE,UADnG,SAEtBuB,IAFsB,EAGtBzB,MAHsB,EAItB,cAJsB,CAAxB;AAMAD,gBAAImF,OAAJ,CAAY1D,OAAZ,CAAoB,SAAS2D,IAAT,CAAcC,MAAd,EAAsB;AACxCA,qBAAOxF,IAAP,CAAYiB,qBAAZ;AACD,aAFD;AAGA;;AAEAyD,yBAAae,MAAb,CAAoBf,aAAagB,OAAb,CAAqB7D,IAArB,CAApB,EAAgD,CAAhD;AACA8D,mBAAOjB,YAAP,EAAqBtE,MAArB;AACA,mBAAO,IAAP;AACD,WAnBI,CAAP;AAoBD;AACF,OA3BH,EA4BG8D,KA5BH,CA4BS;AAAA,eAAK3B,QAAQC,GAAR,CAAY,0BAAZ,EAAwC2B,EAAE5C,OAA1C,CAAL;AAAA,OA5BT;AA6BD,KA/BH;AAgCD,GApCD,MAoCO;AACLgB,YAAQC,GAAR,CAAY,2BAAZ;AACD;AACF,CAxCD;;AA0CA,IAAMmD,SAAS,SAATA,MAAS,CAACjE,QAAD,EAAWtB,MAAX,EAAsB;AACnCsB,WAASE,OAAT,CAAkB;AAAA,WAChBxC,GAAGC,QAAQkF,kBAAR,CAA2B1C,IAA3B,EAAiCzB,MAAjC,EAAyCnB,OAAOuF,cAAhD,CAAH,EACGN,KADH,CACS;AAAA,aAAK3B,QAAQC,GAAR,CAAY2B,EAAE5C,OAAd,CAAL;AAAA,KADT,CADgB;AAAA,GAAlB;AAGD,CAJD;;AAMA;AACA,IAAM0C,oBAAoB,SAApBA,iBAAoB,GAAM;AAC9B2B,cAAY,YAAM;AAChB5E,UAAMY,OAAN,CACE,UAACiE,IAAD,EAAOC,SAAP,EAAqB;AACnBvD,cAAQC,GAAR,CAAY,UAAZ,EAAwBqD,KAAK9E,KAAL,CAAWiD,MAAnC,EAA4C,iBAA5C,EAA+D8B,SAA/D;AACArB,mBAAaoB,KAAKjF,IAAlB,EAAwBiF,KAAK9E,KAA7B;AACD,KAJH;AAKD,GAND,EAMG,GANH;AAOD,CARD;;AAUA,IAAMsD,oBAAoB,SAApBA,iBAAoB,CAACxC,IAAD,EAAU;AAClC,SAAO,IAAIkE,OAAJ,CAAY,UAAUC,OAAV,EAAmBC,MAAnB,EAA2B;AAC5C,WAAO7G,GAAGC,QAAQ6G,kBAAR,CAA2BrE,IAA3B,CAAH,EAAqC6B,IAArC,CAA0C,UAAC9D,GAAD,EAAS;AACxD,UAAMuG,aAAa;AACjB9F,mBAAWT,IAAIwG,IAAJ,CAASC,GADH;AAEjB/F,oBAAYV,IAAIwG,IAAJ,CAAStF,IAFJ;AAGjBP,qBAAaX,IAAIwG,IAAJ,CAASE,OAAT,CAAiB,CAAjB,EAAoBxF,IAHhB;AAIjBN,uBAAeZ,IAAI2G,WAJF;AAKjB9F,uBAAeoB,KAAKf,IALH;AAMjBJ,wBAAgBmB,KAAKhB;AANJ,OAAnB;AAQA,aAAOmF,QAAQG,UAAR,CAAP;AACD,KAVM,EAWJjC,KAXI,CAWE;AAAA,aAAK+B,iCAA+B9B,EAAE5C,OAAjC,CAAL;AAAA,KAXF,CAAP;AAYD,GAbM,CAAP;AAcD,CAfD;;AAiBA;AACA,IAAMiF,MAAM,yBACTvG,GADS,CACL,GADK,EACAV,MADA,EAETkH,MAFS,CAEFxH,OAAOyH,WAFL,EAEkB;AAAA,SAAMnE,QAAQC,GAAR,mBAA4BvD,OAAOyH,WAAnC,CAAN;AAAA,CAFlB,CAAZ;;AAIA;AACA;AACAvG,MAAM,IAAIjB,YAAJ,CAAiB,EAAEyH,QAAQH,GAAV,EAAeI,MAAM,SAArB,EAAjB,CAAN;AACA;;;AAGA;AACAhB,YACE,YAAM;AACJ,MAAMiB,QAAQ,IAAIC,YAAJ,CAAiB,CAAjB,CAAd;AACA,OAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIF,MAAM7C,MAA1B,EAAkC,EAAE+C,CAApC,EAAuC;AACrCF,UAAME,CAAN,IAAWA,IAAI,CAAf;AACD;;AAED5G,MAAImF,OAAJ,CAAY1D,OAAZ,CAAoB,SAAS2D,IAAT,CAAcC,MAAd,EAAsB;AACxC;AACD,GAFD;AAID,CAXH,EAWK,IAXL;AAaArF,IAAI6G,EAAJ,CAAO,YAAP,EAAqB,SAASC,UAAT,CAAoBC,EAApB,EAAwB;AAC3C;AACAA,KAAGF,EAAH,CAAM,SAAN,EAAiB,UAACzF,OAAD,EAAa;AAC5BgB,YAAQC,GAAR,CAAYjB,OAAZ;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACD,GAbD;;AAiBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACD,CA9BD","file":"server.js","sourcesContent":["/*jshint esversion: 6 */\n// SETTINGS\n// DEPENDANCIES\nrequire('dotenv').config();\nimport express from 'express';\nimport querystring from 'querystring';\nconst SocketServer = require('ws').Server;\nconst RP = require('request-promise');\nconst spotify = require('./utils/spotify_func');\nconst config = require('./utils/config');\nconst urls = require('./utils/urls');\n\n// IMPORTS\nimport { URLfactory, defaultNameCheck, generateRandomString, wait_promise, queryStringError, makeBuffer } from './utils/tools'\nimport { SELECTOR_CALLS, ERROR, MODE, CONNECTION } from './utils/constants'\n\nconst router = express.Router();\n\n// Cross Domain Origin Setup\nvar allowCrossDomain = function (req, res, next) {\n  res.header('Access-Control-Allow-Origin', '*');\n  res.header('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE,OPTIONS');\n  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, Content-Length, X-Requested-With');\n  if ('OPTIONS' == req.method) {\n    res.send(200);\n  }\n  else {\n    next();\n  }\n};\n\nexpress().use(allowCrossDomain);\nexpress().use(function (req, res, next) {\n  res.setHeader('Access-Control-Allow-Origin', '*');\n  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS, PUT, PATCH, DELETE');\n  res.setHeader('Access-Control-Allow-Headers', 'X-Requested-With,content-type');\n  res.setHeader('Access-Control-Allow-Credentials', true);\n  next();\n});\n\n// Global state\nlet wss\nlet master = {\n  track_uri: null,\n  track_name: null,\n  artist_name: null,\n  play_position: null,\n  selector_name: null,\n  selector_token: null,\n  album_cover: null,\n};\nconst host = { token: null, name: null };\nlet users = [];\nlet rooms = [];\nlet system_message_buffer = JSON.stringify({\n  type: '',\n  user_object: {},\n  master_object: {},\n  message: 'test'\n});\nlet message_buffer = JSON.stringify({\n  type: '',\n  user_object: {},\n  master_object: {},\n  message: 'test'\n});\n\n\n// get user details object from Spotify with token\nconst getCurrentUser = (token) => {\n  let allUsers = [...users, host];\n  let user_to_return;\n  allUsers.forEach(user => {\n    if (user.token === token) {\n      user_to_return = user;\n    }\n  });\n  return user_to_return;\n};\n\n\n// Endpoints \n// Host login\nrouter.get('/login', function (req, res) {\n  const state = generateRandomString(16);\n  res.cookie(config.STATE_KEY, state);\n  if (!host.token) {\n    res.redirect(`https://accounts.spotify.com/authorize?${querystring.stringify(spotify.spotifyOptions(urls.HOST_REDIRECT_URI[config.MODE], state))}`)\n  } else {\n    res.redirect(URLfactory('alreadyHosted'));\n    console.log('already hosted')\n  }\n});\n// Guest Login\nrouter.get('/invite', function (req, res) {\n  const state = generateRandomString(16);\n  res.cookie(config.STATE_KEY, state);\n  if (host.token) {\n    res.redirect(`https://accounts.spotify.com/authorize?${querystring.stringify(spotify.spotifyOptions(urls.GUEST_REDIRECT_URI[config.MODE], state))}`);\n  } else {\n    res.redirect(URLfactory('no_Host_Connected', ERROR));\n    console.log('No Host Connected')\n  }\n});\n// Host Callback from spotify\nrouter.get('/callback', function (req, res) {\n  const code = req.query.code || null;\n  const state = req.query.state || null;\n  const storedState = req.headers.cookie ? req.headers.cookie.split(`${config.STATE_KEY}=`)[1] : null;\n  if (state === null || state !== storedState) {\n    res.redirect('/#' + queryStringError);\n  } else {\n    res.clearCookie(config.STATE_KEY);\n\n    RP.post(spotify.authOptions(urls.HOST_REDIRECT_URI[config.MODE], code), function (error, response, body) {\n      if (!error && response.statusCode === 200) {\n        host.token = body.access_token;\n        /* get user details and start websockets. Send greeting and token to client then start\n        polling the spotify api for track changes */\n        RP(spotify.getUserOptions(host))\n          .then((user_details) => {\n            // startWebsocket()\n            // pollWebsocket()\n            host.name = defaultNameCheck(user_details.display_name);\n            rooms.push({ host: host, users:[] });\n            system_message_buffer = makeBuffer(`${defaultNameCheck(host.name)} stepped up to the 1210s..`, host, master, CONNECTION)\n            res.redirect(URLfactory('hostLoggedIn?' + querystring.stringify({ token: host.token, room_index: rooms.length })));\n            pollUsersPlayback();\n          })\n          .catch(e => {\n            res.redirect(URLfactory('getting_host_options', ERROR));\n            console.log('Getting host options ', e)\n          });\n      } else {\n        res.redirect(URLfactory('spotify_host_auth', ERROR));\n        console.log('Spotify host auth ', e)\n      }\n    });\n  }\n});\n// Guest callback from Spotify\nrouter.get('/guestcallback', function (req, res) {\n  const code = req.query.code || null;\n  const state = req.query.state || null;\n  const room_index = req.query.room_index || 0;\n  const storedState = req.headers.cookie ? req.headers.cookie.split(`${config.STATE_KEY}=`)[1] : null;\n  if (state === null || state !== storedState) {\n    res.redirect('/#' + queryStringError);\n  } else {\n    res.clearCookie(config.STATE_KEY);\n\n    RP.post(spotify.authOptions(urls.GUEST_REDIRECT_URI[config.MODE], code), function (error, response, body) {\n      if (!error && response.statusCode === 200) {\n        let newUser = {};\n        newUser.token = body.access_token;\n        RP(spotify.getUserOptions(newUser))\n          .then(user_details => {\n            console.log(`${user_details.name} trying to join.`);\n            newUser.name = user_details.display_name;\n\n            return checkCurrentTrack(host, master);\n          })\n          .then(obj => {\n            master = obj;\n            // after current track in master state is checked set playback for current user\n            return RP(spotify.setPlaybackOptions(newUser, master, config.PLAYBACK_DELAY));\n          })\n          .then(() => {\n            // add new user to global user array\n            rooms[room_index].users.push(newUser);\n            // users = [...users, newUser];\n            system_message_buffer = makeBuffer(`${defaultNameCheck(newUser.name)} joined the party...`, newUser, master, CONNECTION)\n            res.redirect(URLfactory('guestLoggedIn?' + querystring.stringify({ token: newUser.token })))\n          })\n          .catch(e => {\n            res.redirect(URLfactory('guest_sync', ERROR))\n            console.log('Error in guest sync ', e)\n          })\n      } else {\n        res.redirect(URLfactory('guest_callback', ERROR))\n        console.log('Error in guest callback ', e)\n      }\n    })\n  }\n});\n\n\nconst syncToMaster = (host, users) => {\n  if (host.token && users) {\n    let allRoomUsers = [...users, host];\n    console.log('syncing room')\n    // make reference to users, leave global users array immutable\n    allRoomUsers.some(\n      (user) => {\n        wait_promise(350)\n          .then(() => checkCurrentTrack(user))\n          .then(result => {\n            if (result.track_uri !== master.track_uri) {\n              // Check users current track, if URI is different to one in master state ...\n              master = result;\n              return RP(spotify.getTrack(user, master.track_uri.split('track:')[1]))\n                .then((track) => {\n                  master.album_cover = track.album.images[0].url\n                  /* get the new tracks cover image and set the master to the new track that is taking over\n                  then set the system message buffer to send update info to the client */\n                  system_message_buffer = makeBuffer(\n                    `${defaultNameCheck(master.selector_name)} ${SELECTOR_CALLS[Math.floor(Math.random() * SELECTOR_CALLS.length)]} ${master.track_name}!!`,\n                    user,\n                    master,\n                    'track_change'\n                  );\n                  wss.clients.forEach(function each(client) {\n                    client.send(system_message_buffer);\n                  });\n                  /* remove the current user from the reference to the array of users\n                  and then run through all the remaining users setting their track details to master */\n                  allRoomUsers.splice(allRoomUsers.indexOf(user), 1)\n                  resync(allRoomUsers, master);\n                  return true;\n                })\n            }\n          })\n          .catch(e => console.log('Error in sync to master ', e.message))\n      })\n  } else {\n    console.log('only one user in the room');\n  }\n}\n\nconst resync = (allUsers, master) => {\n  allUsers.forEach((user =>\n    RP(spotify.setPlaybackOptions(user, master, config.PLAYBACK_DELAY))\n      .catch(e => console.log(e.message))));\n};\n\n// polling loop at 350ms\nconst pollUsersPlayback = () => {\n  setInterval(() => {\n    rooms.forEach(\n      (room, roomIndex) => {\n        console.log('syncing ', room.users.length , ' users in room ', roomIndex);\n        syncToMaster(room.host, room.users);\n      });\n  }, 350);\n};\n\nconst checkCurrentTrack = (user) => {\n  return new Promise(function (resolve, reject) {\n    return RP(spotify.getPlaybackOptions(user)).then((res) => {\n      const master_ref = {\n        track_uri: res.item.uri,\n        track_name: res.item.name,\n        artist_name: res.item.artists[0].name,\n        play_position: res.progress_ms,\n        selector_name: user.name,\n        selector_token: user.token\n      }\n      return resolve(master_ref);\n    })\n      .catch(e => reject(`in checkCurrentTrack ${e.message}`));\n  });\n};\n\n// START SERVER AND SOCKET\nconst app = express()\n  .use('/', router)\n  .listen(config.SERVER_PORT, () => console.log(`Listening on ${config.SERVER_PORT}`));\n\n// CONNECT TO WEBSOCKET THROUGH wss://<app-name>.herokuapp.com:443/socket\n// const startWebsocket = () => {\nwss = new SocketServer({ server: app, path: \"/socket\" });\n// }\n\n\n// const pollWebsocket = () => {\nsetInterval(\n  () => {\n    const array = new Float32Array(5);\n    for (var i = 0; i < array.length; ++i) {\n      array[i] = i / 2;\n    }\n\n    wss.clients.forEach(function each(client) {\n      // client.send(array);\n    });\n\n  }, 2000)\n  ;\nwss.on('connection', function connection(ws) {\n  //if we get a message send it back to the clients with master object and label it with user token\n  ws.on('message', (message) => {\n    console.log(message)\n    // const message_rec = JSON.parse(message)\n    // switch (message_rec.type){\n    //   case 'message': \n    // message_buffer = JSON.stringify({\n    //     type: 'message',\n    //     user_object: getCurrentUser(message_rec.token) || 'DJ Unknown',\n    //     master_object: master,\n    //     message: message_rec.message\n    //   })\n    // default: break;\n    // }\n  });\n\n\n\n  // send system and message_buffer from global state every 200ms and then reset state\n  // setInterval(\n  //   () => {\n  //    wss.clients.forEach((client) => {\n  //       system_message_buffer && client.send(system_message_buffer)\n  //       message_buffer && client.send(message_buffer)\n  //     });\n  //     message_buffer = ''\n  //     system_message_buffer = ''\n  //   },200)\n  // });\n});"]}